# 🎯 相场PINN参数调优速查表

## 📊 诊断流程图

```
运行测试 → 查看损伤场
    ↓
d_mean > 0.5?  YES → 全域高损伤（diffuse）→ 跳转到 [方案A]
    ↓ NO
d_max < 0.3?   YES → 没有裂纹形成 → 跳转到 [方案B]
    ↓ NO
裂纹太宽?      YES → 弥散裂纹 → 跳转到 [方案C]
    ↓ NO
✓ 成功！局部化裂纹
```

---

## [方案A] 解决全域高损伤

### 症状
```
d ∈ [0.8, 0.9]  全域
d_mean > 0.5
d_std < 0.1 (太均匀)
```

### 处方（按优先级）

#### ⭐⭐⭐⭐⭐ 第一步：调整能量尺度

| 参数 | 当前 | 改为 | 效果 |
|-----|------|------|------|
| **Gc** | 2.7e-3 | **8.0e-3** | 材料更难破坏 ×3 |
| **l** | 0.02 | **0.01** | 裂纹更窄 ÷2 |

```python
# 经验规则
l/L = 0.5~2%         # 长度尺度占比
Gc × (2~5)           # 增大断裂能
```

#### ⭐⭐⭐⭐ 第二步：更细的加载

| 参数 | 当前 | 改为 | 效果 |
|-----|------|------|------|
| **n_steps** | 5 | **20** | 渐进式加载 ×4 |
| **max_disp** | 0.01 | **0.005** | 总载荷减半 ÷2 |

```python
loading_steps = np.linspace(0, 0.005, 20)
```

#### ⭐⭐⭐ 第三步：强化不可逆性

| 参数 | 当前 | 改为 | 效果 |
|-----|------|------|------|
| **weight_irrev** | 100 | **500** | 不可逆约束 ×5 |
| **projection** | 无 | **max(d,d_prev)** | 硬约束 |

```python
# 在训练循环中添加
d_new = torch.maximum(d_current, d_previous)
```

#### ⭐⭐ 第四步：稳定训练

| 参数 | 当前 | 改为 | 效果 |
|-----|------|------|------|
| **lr** | 1e-3 | **2e-4** | 学习率 ÷5 |
| **grad_clip** | 无 | **1.0** | 梯度裁剪 |
| **epochs** | 500 | **1000** | 训练时间 ×2 |

```python
torch.nn.utils.clip_grad_norm_(params, 1.0)
```

---

## [方案B] 解决裂纹未形成

### 症状
```
d_max < 0.3
d_mean ≈ d_max (无对比)
无明显高损伤区
```

### 处方

#### ⭐⭐⭐⭐⭐ 增大总载荷

```python
max_displacement = 0.008  # 从0.005增至0.008
# 或
n_loading_steps = 30      # 更多步
```

#### ⭐⭐⭐⭐ 增加训练时间

```python
n_epochs_per_step = 2000  # 加倍训练
```

#### ⭐⭐⭐ 降低Gc（慎用）

```python
G_c = 5.0e-3  # 从8.1e-3降至5.0e-3
# 警告：可能重新导致弥散！
```

#### ⭐⭐ 检查边界条件

```python
# 确保拉伸BC正确
u_bc[top_boundary, 1] = load_value  # v方向
```

---

## [方案C] 解决裂纹太宽

### 症状
```
d_max > 0.8 ✓
d_mean > 0.3 ✗
裂纹带宽度 > 5%
```

### 处方

#### ⭐⭐⭐⭐⭐ 减小长度尺度

```python
l = 0.008   # 从0.01减至0.008
# 或更激进
l = 0.005   # 减至0.5%
```

#### ⭐⭐⭐⭐ 增加采样密度

```python
n_domain = 5000  # 从2000增至5000
# 特别在裂纹区域
```

#### ⭐⭐⭐ 调整c0归一化

```python
c_0 = 8/3  # AT2模型
# 或
c_0 = 2    # AT1模型（更窄裂纹）
```

---

## 🔢 参数速查表

### 材料参数

| 参数 | 典型值 | 单位 | 物理意义 |
|-----|-------|------|---------|
| **E** | 200-210 | GPa | 杨氏模量（硬度） |
| **ν** | 0.2-0.3 | - | 泊松比 |
| **Gc** | 2-10 × 10⁻³ | kN/mm | 断裂能（越大越难破坏） |
| **l** | 0.005-0.02 | - | 长度尺度（裂纹宽度≈4l） |
| **k** | 10⁻⁶-10⁻⁴ | - | 残余刚度 |

### 训练参数

| 参数 | 快速 | 标准 | 高精度 |
|-----|------|------|--------|
| **lr** | 5e-4 | 2e-4 | 1e-4 |
| **n_steps** | 10 | 20 | 50 |
| **epochs/step** | 500 | 1000 | 2000 |
| **n_domain** | 1000 | 3000 | 5000 |
| **max_disp** | 0.003 | 0.005 | 0.008 |

### 权重参数

| 参数 | 最小 | 标准 | 强约束 |
|-----|------|------|--------|
| **weight_bc** | 50 | 100 | 500 |
| **weight_irrev** | 100 | 500 | 2000 |
| **grad_clip** | 0.5 | 1.0 | 2.0 |

---

## 📐 关键比值

### Gc/l 比值（最重要！）

```
Gc/l < 0.2   → 弥散损伤风险高
Gc/l = 0.5~1 → 理想范围 ✓
Gc/l > 2     → 裂纹难形成
```

**计算**:
```python
ratio = G_c / l
print(f"Gc/l = {ratio:.2f}")

# 目标：0.5~1.0
if ratio < 0.5:
    print("建议: 增大Gc或减小l")
elif ratio > 1.5:
    print("建议: 减小Gc或增大l")
```

### l/L 比值

```
l/L < 0.5%   → 裂纹太窄，难以捕捉
l/L = 1~2%   → 理想范围 ✓
l/L > 3%     → 裂纹太宽，弥散
```

### 加载增量

```
Δδ/L < 0.05%  → 可能太小
Δδ/L = 0.1%   → 理想 ✓
Δδ/L > 0.5%   → 可能太大
```

---

## 🎨 可视化判断

### 损伤场颜色解读

```
🟨 黄色 (d < 0.1)  → 完好区域 ✓
🟧 橙色 (0.1-0.5)  → 过渡带
🟥 红色 (0.5-0.8)  → 部分损伤
🟪 紫色 (> 0.8)    → 裂纹核心 ✓
```

**理想分布**:
- 90%黄色 + 5%橙色 + 5%红紫
- 红紫区域形成窄带

**问题分布**:
- 全橙色/全红色 → 弥散损伤
- 全黄色 → 无裂纹

### 损伤直方图

```
理想直方图:
频率 |        ██
    |        ██
    |   ██   ██
    |   ██   ██  ██
    |___██___██__██___
        0   0.5  1.0  损伤d
        ↑        ↑
      完好峰  裂纹峰

问题直方图:
频率 |     ████████   ← 单峰，集中在中高值
    |     ████████
    |_____████████_____
         0.7 0.9  d
```

---

## 🚦 收敛判据

### 损失函数

```python
# 每个加载步末尾应该满足
loss_final < 1e-3      # 总损失
L_bc < 1e-4            # 边界条件
L_energy 稳定不增      # 能量收敛
```

### 损伤场统计

```python
# 判断是否成功局部化
success = (
    d_mean < 0.3 and      # 平均低
    d_max > 0.7 and       # 最大高
    d_std > 0.2           # 标准差大
)
```

### 损伤演化

```python
# d_max vs load 曲线应该显示
# 1. 初始平台（弹性阶段）
# 2. 转折点（起裂）
# 3. 增长阶段（裂纹扩展）

if has_clear_turning_point(curve):
    print("✓ 物理合理的演化")
```

---

## 🔧 常见问题快速修复

| 问题 | 快速修复 | 代码 |
|-----|---------|------|
| 损失不降 | 降低lr | `lr = lr / 5` |
| 损失震荡 | 加梯度裁剪 | `clip_grad_norm_(p, 1.0)` |
| d全是0 | 增大载荷 | `max_disp *= 2` |
| d全是1 | 增大Gc | `G_c *= 3` |
| 训练太慢 | 减少点/epochs | `n_domain /= 2` |
| 裂纹弥散 | 减小l | `l /= 2` |

---

## 💡 调优工作流

### 第一轮：快速原型（~5分钟）

```python
config = {
    'G_c': 5.0e-3,
    'l': 0.015,
    'lr': 5e-4,
}
n_steps = 10
epochs = 500
n_domain = 1000
```

**目标**: 看到任何形式的局部化迹象

### 第二轮：标准测试（~15分钟）

```python
config = {
    'G_c': 8.0e-3,
    'l': 0.01,
    'lr': 2e-4,
}
n_steps = 20
epochs = 1000
n_domain = 3000
```

**目标**: 清晰的裂纹带

### 第三轮：高精度（~1小时）

```python
config = {
    'G_c': 10.0e-3,  # 根据第二轮结果微调
    'l': 0.008,
    'lr': 1e-4,
}
n_steps = 50
epochs = 2000
n_domain = 5000
```

**目标**: 发表级质量

---

## 📝 调优日志模板

```python
# 实验记录
experiment = {
    'date': '2024-xx-xx',
    'config': {
        'G_c': 8.1e-3,
        'l': 0.01,
        'lr': 2e-4,
    },
    'results': {
        'd_max': 0.85,
        'd_mean': 0.12,
        'd_std': 0.28,
        'localized': True,  # ✓
    },
    'notes': '第一次看到清晰裂纹带！'
}
```

---

## 🎓 进阶tips

1. **固定随机种子**
```python
torch.manual_seed(42)
np.random.seed(42)
```

2. **保存检查点**
```python
torch.save({
    'u_net': u_net.state_dict(),
    'd_net': d_net.state_dict(),
    'step': n,
}, f'checkpoint_step{n}.pt')
```

3. **可视化中间步**
```python
if n % 5 == 0:  # 每5步
    visualize_solution(...)
```

4. **记录能量分解**
```python
history.append({
    'E_bulk': E_bulk.item(),
    'E_frac': E_frac.item(),
    'ratio': E_frac/(E_bulk+E_frac),
})
```

现在你有了完整的调优工具箱！🚀
